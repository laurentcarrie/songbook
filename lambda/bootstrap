#!/bin/bash
set -euo pipefail

# AWS Lambda custom runtime bootstrap
# This script handles Lambda invocation and runs band-songbook

# Runtime API endpoint
RUNTIME_API="${AWS_LAMBDA_RUNTIME_API}"

# S3 configuration
S3_BUCKET="zik-laurent"
S3_SONGS_PREFIX="songs"
S3_SANDBOX_PREFIX="sandbox"

# Local working directories (Lambda has /tmp for writable storage)
LOCAL_SONGS="/tmp/songs"
LOCAL_SANDBOX="/tmp/sandbox"

# Function to send response back to Lambda
send_response() {
    local request_id="$1"
    local response="$2"
    curl -sS -X POST \
        "http://${RUNTIME_API}/2018-06-01/runtime/invocation/${request_id}/response" \
        -d "${response}"
}

# Function to send error back to Lambda
send_error() {
    local request_id="$1"
    local error_message="$2"
    curl -sS -X POST \
        "http://${RUNTIME_API}/2018-06-01/runtime/invocation/${request_id}/error" \
        -d "{\"errorMessage\": \"${error_message}\", \"errorType\": \"RuntimeError\"}"
}

# Main processing loop
while true; do
    # Get next invocation
    HEADERS=$(mktemp)
    EVENT_DATA=$(curl -sS -LD "${HEADERS}" \
        "http://${RUNTIME_API}/2018-06-01/runtime/invocation/next")

    # Extract request ID from headers
    REQUEST_ID=$(grep -Fi "Lambda-Runtime-Aws-Request-Id" "${HEADERS}" | tr -d '[:space:]' | cut -d: -f2)
    rm -f "${HEADERS}"

    echo "Received invocation: ${REQUEST_ID}"
    echo "Event data: ${EVENT_DATA}"

    # Clean up from previous invocations
    rm -rf "${LOCAL_SONGS}" "${LOCAL_SANDBOX}"
    mkdir -p "${LOCAL_SONGS}" "${LOCAL_SANDBOX}"

    # Step 1: Download songs from S3
    echo "Downloading songs from S3..."
    if ! aws s3 sync "s3://${S3_BUCKET}/${S3_SONGS_PREFIX}/" "${LOCAL_SONGS}/" 2>&1; then
        send_error "${REQUEST_ID}" "Failed to download songs from S3"
        continue
    fi

    # Step 2: Run band-songbook
    echo "Running band-songbook..."
    if OUTPUT=$(/usr/local/bin/band-songbook \
        --srcdir "${LOCAL_SONGS}" \
        --sandbox "${LOCAL_SANDBOX}" \
        --settings "${LOCAL_SONGS}/settings.yml" 2>&1); then

        echo "band-songbook completed successfully"
        echo "${OUTPUT}"

        # Step 3: Upload sandbox results to S3
        echo "Uploading sandbox to S3..."
        if ! aws s3 sync "${LOCAL_SANDBOX}/" "s3://${S3_BUCKET}/${S3_SANDBOX_PREFIX}/" --delete 2>&1; then
            send_error "${REQUEST_ID}" "Failed to upload sandbox to S3"
            continue
        fi

        # Send success response
        RESPONSE=$(jq -n \
            --arg output "${OUTPUT}" \
            --arg status "success" \
            '{statusCode: 200, body: {status: $status, output: $output}}')
        send_response "${REQUEST_ID}" "${RESPONSE}"
    else
        EXIT_CODE=$?
        echo "band-songbook failed with exit code ${EXIT_CODE}"
        echo "${OUTPUT}"

        # Send error response
        send_error "${REQUEST_ID}" "band-songbook failed: ${OUTPUT}"
    fi
done
